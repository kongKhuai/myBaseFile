作者：林三心
网址：[删除 node_modules 太慢了？教你个小技巧！](https://mp.weixin.qq.com/s/g61WqENuguqb0hl6XIY6Wg)

在开发过程中，`node_modules` 文件夹常常会因为存放了大量的依赖包而变得庞大，尤其是在大型项目中。虽然 `node_modules` 是 Node.js 项目中不可或缺的一部分，但在一些特定的情况下，比如清理无用依赖或是重新安装依赖时，删除 `node_modules` 文件夹是一个常见的操作。然而，手动删除这么大的文件夹往往是一个耗时且效率低下的过程。对于开发者而言，如何快速有效地删除 node_modules 成为了一个常见的痛点。

这时，`rimraf` 工具就显得尤为重要，它可以替代`rm -rf`命令来递归删除文件夹，并且相较于手动删除，它提供了更高效的方式。

## 一、什么是 rimraf？

rimraf 是一个 Node.js 库，用于递归地删除文件和目录，特别适用于删除 node_modules 这样的庞大文件夹。rimraf 在删除文件和文件夹时，采用了优化过的实现，特别能够提高大文件夹删除的效率。

与操作系统自带的 rm -rf 命令相比，rimraf 通过减少系统调用、避免进程挂起等方式，能够加快删除过程，尤其在 Windows 平台上表现尤为突出，因为 Windows 本身对于删除大量文件的支持不如类 Unix 系统。

## 二、为什么手动删除 node_modules 这么慢？

在大型 Node.js 项目中，`node_modules` 文件夹可能包含上万个文件和子文件夹。由于 `node_modules` 文件夹结构的复杂性和深度，手动删除该文件夹需要操作系统一次性处理大量的文件删除操作。在这种情况下，操作系统的文件系统（如 macOS 的 HFS+ 或 Windows 的 NTFS）可能会出现延迟，导致删除过程非常缓慢。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/TZL4BdZpLdiahKsq9NS0GlQqSQyb7mUR5DOq5tcO8dopfxm73p1O8pFrOVAXNsXNKG5S44WzD4CuNGmz7ILFKsQ/640?wx_fmt=jpeg&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### 1. 操作系统的文件系统限制

操作系统的文件系统并没有针对大规模删除优化。例如，当你使用文件资源管理器删除文件时，它实际上是逐一标记每个文件为删除状态，并且还会消耗大量的资源来更新文件索引。这对于 node_modules 这种成千上万个文件的文件夹来说，执行起来非常低效。

### 2. 文件系统缓存和索引

文件操作系统通常会保持一定的缓存和索引记录，以便加速文件的读写和删除过程。然而，当需要删除大量文件时，这些缓存和索引会成为瓶颈，导致删除变得缓慢。

## 三、如何使用 rimraf 加速删除过程？

`rimraf` 是一个专为递归删除大文件夹设计的工具，它通过优化删除过程中的一些细节，避免了文件系统缓存和索引的限制，使得删除过程更加高效。使用 `rimraf` 删除 `node_modules` 的步骤非常简单，以下是详细的操作流程。

### 1. 安装 rimraf

首先，我们需要在项目中安装 rimraf。可以通过 npm 或 yarn 来安装它。打开你的命令行，进入到你的项目目录下，执行以下命令：

```
npm install rimraf --save-dev
```

或者使用 yarn：

```
yarn add rimraf --dev
```

通过这个命令，rimraf 将作为开发依赖安装在你的项目中。

### 2. 在命令行中使用 rimraf

安装完成后，你可以在命令行中直接使用 rimraf 来删除 node_modules 文件夹。以下是使用 rimraf 删除 node_modules 的命令：

```
npx rimraf node_modules
```

npx 是 npm 5.2 以上版本自带的工具，它可以直接运行安装在本地 node_modules/.bin 文件夹中的命令，无需全局安装。

### 3. 在 package.json 中配置脚本

为了简化操作，很多开发者将删除 node_modules 的命令添加到 package.json 中的 scripts 部分。这样，每次需要删除 node_modules 时，只需运行一个脚本命令即可。

在 package.json 中添加如下脚本：

```
{  "scripts": {    "clean": "rimraf node_modules"  }}
```

然后你可以通过以下命令来删除 `node_modules`：

```
npm run clean
```

这样，你就能够更加便捷地清理项目中的 node_modules 文件夹。

### 4. 使用 rimraf 加速其他删除操作

除了删除 node_modules 文件夹，rimraf 还可以用于删除任何其他大文件夹或大量文件。比如，你可能在构建过程中生成了临时文件夹，或者你希望删除构建目录中的文件，rimraf 都能高效完成。

使用方法和删除 node_modules 文件夹一样：

```
rimraf <path-to-folder>
```

例如：

```
npx rimraf build
```

这样，你就能够迅速删除 build 文件夹，而无需担心删除速度慢或操作系统不稳定的问题。

## 四、rimraf 的优势

- 跨平台兼容：rimraf 能够在 Linux、macOS 和 Windows 上良好工作，不同操作系统之间的一致性使得它成为开发团队中的常用工具。
    
- 高效删除：rimraf 对于大规模删除（尤其是上万个文件）有较为高效的处理能力，相比手动删除或使用系统自带的命令，它明显提高了速度。
    
- 易于使用：通过命令行和 package.json 中的配置，开发者可以快速上手，简化了删除过程。
    
- 与 npm、yarn 配合良好：rimraf 可以无缝集成到现有的 Node.js 项目中，与包管理工具如 npm、yarn 配合使用，使得整个开发流程更加流畅。
    

## 五、总结

在开发过程中，node_modules 文件夹的删除往往是一项繁琐且耗时的操作，尤其在项目中依赖较多时，删除过程会非常缓慢。手动删除不仅费时，而且还容易造成系统负担。使用 rimraf 来替代手动删除，可以显著提高删除速度，特别是在 Windows 等文件系统较弱的操作系统上。通过 rimraf，你不仅能够快速删除 node_modules，还能够在其他场合使用它加速文件夹清理。

总之，rimraf 是一个轻量级、高效且跨平台的工具，非常适合在 Node.js 开发中用于删除大文件夹，尤其是 node_modules。如果你还在手动删除 node_modules，不妨试试 rimraf，它能大大提升你的工作效率。

